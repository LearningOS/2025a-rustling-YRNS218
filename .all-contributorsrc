use serde::{Deserialize, Serialize};
use serde_json::{self, Result};
use std::fs;

/// 贡献者信息结构体
#[derive(Debug, Serialize, Deserialize)]
struct Contributor {
    login: String,
    name: String,
    avatar_url: String,
    profile: String,
    contributions: Vec<String>,
}

/// 配置主结构体
#[derive(Debug, Serialize, Deserialize)]
struct Config {
    files: Vec<String>,
    imageSize: u64,
    commit: bool,
    contributors: Vec<Contributor>,
    contributorsPerLine: u64,
    projectName: String,
    projectOwner: String,
    repoType: String,
    repoHost: String,
    skipCi: bool,
    commitConvention: String,
    commitType: String,
}

impl Config {
    /// 从JSON文件加载配置
    fn from_file(path: &str) -> Result<Self> {
        let data = fs::read_to_string(path)?;
        serde_json::from_str(&data)
    }

    /// 保存配置到JSON文件
    fn to_file(&self, path: &str) -> Result<()> {
        let json = serde_json::to_string_pretty(self)?;
        fs::write(path, json)?;
        Ok(())
    }

    /// 获取贡献者数量
    fn contributor_count(&self) -> usize {
        self.contributors.len()
    }

    /// 根据贡献类型筛选贡献者
    fn get_contributors_by_type(&self, contribution_type: &str) -> Vec<&Contributor> {
        self.contributors
            .iter()
            .filter(|c| c.contributions.contains(&contribution_type.to_string()))
            .collect()
    }

    /// 添加新贡献者
    fn add_contributor(&mut self, contributor: Contributor) {
        self.contributors.push(contributor);
    }
}

fn main() -> Result<()> {
    // 示例JSON数据（你提供的内容）
    let json_data = r#"{
        "files": ["AUTHORS.md"],
        "imageSize": 100,
        "commit": false,
        "contributors": [
            {
                "login": "carols10cents",
                "name": "Carol (Nichols || Goulding)",
                "avatar_url": "https://avatars2.githubusercontent.com/u/193874?v=4",
                "profile": "http://carol-nichols.com",
                "contributions": ["code", "content"]
            },
            {
                "login": "QuietMisdreavus",
                "name": "QuietMisdreavus",
                "avatar_url": "https://avatars2.githubusercontent.com/u/5217170?v=4",
                "profile": "https://twitter.com/QuietMisdreavus",
                "contributions": ["code", "content"]
            }
        ],
        "contributorsPerLine": 8,
        "projectName": "rustlings",
        "projectOwner": "rust-lang",
        "repoType": "github",
        "repoHost": "https://github.com",
        "skipCi": true,
        "commitConvention": "angular",
        "commitType": "docs"
    }"#;

    // 解析JSON数据
    let mut config: Config = serde_json::from_str(json_data)?;
    println!("成功解析配置，贡献者数量: {}", config.contributor_count());

    // 筛选代码贡献者
    let code_contributors = config.get_contributors_by_type("code");
    println!("代码贡献者数量: {}", code_contributors.len());

    // 添加新贡献者
    let new_contributor = Contributor {
        login: "new_contributor".to_string(),
        name: "New Contributor".to_string(),
        avatar_url: "https://example.com/avatar.jpg".to_string(),
        profile: "https://github.com/new_contributor".to_string(),
        contributions: vec!["doc".to_string(), "content".to_string()],
    };
    config.add_contributor(new_contributor);
    println!("添加新贡献者后总数: {}", config.contributor_count());

    // 保存配置到文件
    config.to_file("contributors_config.json")?;
    println!("配置已保存到 contributors_config.json");

    // 从文件加载配置
    let loaded_config = Config::from_file("contributors_config.json")?;
    println!("从文件加载的配置贡献者数量: {}", loaded_config.contributor_count());

    Ok(())
}
